<!DOCTYPE HTML>
<html>
<head>
    <style> /* General styling */
        html {
            height: 100%;
            overflow: auto;
        }

        body {
            height: 100%;
        }

        .hidden {
            visibility: hidden;
        }

        .closeBtn { /* Styling for the close button (the red x) */
            background: red;
            display: block;
            padding: 2% 3%;
            float: right;
            border-radius: 12px;
            text-decoration: none;
            color: white;
            font-size: 4vh;
            font-weight: bold;
            border-top: 1px solid rgb(250,150,100);
            -webkit-box-shadow: rgba(255,255,255,.3) 0 2px 1px,rgba(0,0,0,.3) 0 -2px 1px, rgba(0,0,0,0.5) 0px 3px 10px, rgba(100,0,0,.75) 0 0 40px inset;
            -moz-box-shadow: rgba(255,255,255,.3) 0 2px 1px,rgba(0,0,0,.3) 0 -2px 1px, rgba(0,0,0,0.5) 0px 3px 10px, rgba(100,0,0,.75) 0 0 40px inset;
            box-shadow: rgba(255,255,255,.3) 0 2px 1px,rgba(0,0,0,.3) 0 -2px 1px, rgba(0,0,0,0.5) 0px 3px 10px, rgba(100,0,0,.75) 0 0 40px inset;
            text-shadow: 0 0 10px #000;
            background: #f3c5bd;
            background: -webkit-linear-gradient(top, #f3c5bd 0%, #e86c57 50%, #ea2803 51%, #ff6600 100%);
            background: -moz-linear-gradient(top, #f3c5bd 0%, #e86c57 50%, #ea2803 51%, #ff6600 100%);
            background: -o-linear-gradient(top, #f3c5bd 0%, #e86c57 50%, #ea2803 51%, #ff6600 100%);
            background: linear-gradient(to bottom, #f3c5bd 0%, #e86c57 50%, #ea2803 51%, #ff6600 100%);
            opacity: 1;
        }

        .buttonHolder { /* centres buttons within their div */
            display: flex;
            justify-content: center;
        }

        .bordered {
            border: 2px dashed blue;
        }
    </style>
    <style>  /* Custom radio buttons and checkboxes */
        /* Style for the label */
        .choiceHolder {
            display: block;
            text-align: left;
            position: relative;
            padding-left: 4vmin;
            margin: 1vmin;
            cursor: pointer;
            font-size: 3vmin;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        /* Hide the browser's default radio button */
        .choiceHolder input {
            position: absolute;
            opacity: 0;
            cursor: pointer;
            height: 0;
            width: 0;
        }

        /* Create a custom radio button */
        .indicator {
            position: absolute;
            left: 0;
            height: 3vmin;
            width: 3vmin;
            background-color: #EEEEEE;
            border-radius: 50%;
        }

        /* On mouse-over, add a grey background color */
        .choiceHolder:hover input ~ .indicator {
            background-color: #CCCCCC;
        }

        /* When the radio button is checked, add a blue background */
        .choiceHolder input:checked ~ .indicator {
            background-color: #2196F3;
        }

        /* Create the indicator (the dot/circle - hidden when not checked) */
        .indicator:after {
            content: "";
            position: absolute;
            display: none;
        }

        /* Show the indicator (dot/circle) when checked */
        .choiceHolder input:checked ~ .indicator:after {
            display: block;
        }

        /* Style the indicator (dot/circle) */
        .choiceHolder .indicator:after {
            top: 0.75vmin;
            left: 0.75vmin;
            width: 1.5vmin;
            height: 1.5vmin;
            border-radius: 50%;
            background: white;
        }
    </style>
    <style> /* Background display */
        .BackgroundContainer {
            height: 100%;
            z-index: 0;
        }

        .fixed {
            background-attachment: fixed;
            background-repeat: repeat-y;
            background-position: center center;
            height: 100%;
            width: 100%;
            color: #eeeeee;
            text-align: center;
            display: table;
        }
    </style>
    <style> /* Sequence display area */
        #SequenceArea {
            position: absolute;
            top: 50vh;
            width: 100%;
            z-index: 1;
            display: flex;
            justify-content: center;
        }

        #SequenceArea img {
            position: absolute;
            width: 50%;
        }
      
        #gameOutline {
            position: relative;
            z-index: 2;
        }
    </style>
    <style> /* Style the SideNavs to be sliding buttons */     
        #SideNavLeft a,#SideNavRight a {
            position: fixed; /* Position them relative to the viewport - not affected by scrolling */
            width: 15vw;
            z-index: 20;

            text-decoration: none; /* Remove underline */
            font-size: 3vh;
            text-align: center; /* Centres text horizontally in the anchor element */
            line-height: 3vh;
            transition: 0.3s; /* Add transition on hover */
            padding: 2vh;
        }

        #SideNavLeft a {
            border-radius: 0 5px 5px 0; /* Rounded corners on the top right and bottom right side */
            left: -15vw; /* Position them outside of the screen */
        }

        #SideNavLeft a:hover {
            left: 0; /* On mouse-over, make the elements appear as they should */
            color: white; /* White text color */
            opacity: 1;
        }

        #SideNavRight a {
            border-radius: 5px 0 0 5px; /* Rounded corners on the top left and bottom left side */
            right: -15vw; /* Position them outside of the screen */
        }

        #SideNavRight a:hover {
            right: 0; /* On mouse-over, make the elements appear as they should */
            color: white; /* White text color */
            opacity: 1;
        }

        #newGame { /* The newgame_verify() link */
            top: 5vh;
            background-color: #04AA6D; /* Green */
            color: #04AA6D;
        }

        #back { /* The game_backToPreviousStep() link */
            top: 16vh;
            background-color: #2196F3;
            color: #2196F3;
        }

        #skip {
            top: 27vh;
            background-color: #f44336;
            color: #f44336;
        }

        #elim {
            top: 49vh;
            background-color: #050505;
            color: #050505;
        }

        #vp {
            top: 60vh;
            background-color: #BDB76B;
            color: #BDB76B;
        }

        #options {
            top: 49vh;
            background-color: #199fA9;
            color: #199fA9;
        }

        #about {
            top: 60vh;
            background-color: #FFC300;
            color: #FFC300;
        }
    </style>
    <style> /* Modal Dialogue */
        /* (adapted from https://cssdeck.com/labs/css3-sleek-black-modal) */
        .modal {
            /* basic */
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            left: 20vw;
            top: 2vw;
            width: 60vw;
            z-index: 10;
            background-color: #fff;
            margin: 0 auto;
            padding: 5px;
            text-align: center;
            /* border-radius */
            border-radius: 12px;
            color: white;
            /* box-shadow */
            -webkit-box-shadow: rgba(0,0,0,0.5) 0px 3px 10px, rgba(0,0,0,.75) 0 0 70px inset;
            -moz-box-shadow: rgba(0,0,0,0.5) 0px 3px 10px, rgba(0,0,0,.75) 0 0 70px inset;
            box-shadow: rgba(0,0,0,0.5) 0px 3px 10px, rgba(0,0,0,.75) 0 0 70px inset;
            background: rgba(125, 126, 125, 0.85);
            background: -moz-linear-gradient(top, rgba(125, 126, 125, 0.85), rgba(14, 14, 14, 0.85));
            background: -webkit-linear-gradient(top, rgba(125, 126, 125, 0.85), rgba(14, 14, 14, 0.85));
            background: -o-linear-gradient(top, rgba(125, 126, 125, 0.85), rgba(14, 14, 14, 0.85));
            background: linear-gradient(to bottom, rgba(125, 126, 125, 0.85), rgba(14, 14, 14, 0.85));
            border-top: 1px solid #666;
            overflow: hidden;
        }

        #modal h1 {
            text-align: left;
            margin: 0;
            font-size: 6vh;
            letter-spacing: -1px;
            margin-bottom: 1vh;
            text-shadow: 0 -1px 1px #000, 0 0px 3px rgba(0,0,0,.25);
        }

        .modal-content p {
            margin-top: 5vh 0 7vh;
            color: #FFD700;
            font-size: 5vh;
            text-align: center;
            text-shadow: 0 0px 5px rgba(0,0,0,.25), 0 -1px 1px #000;
        }

        .modalBtn {
            background: green;
            display: block;
            padding: 5% 5%;
            border-radius: 12px;
            float: left;
            text-decoration: none;
            color: white;
            margin: 5px 5px 5px 5px;
            font-weight: bold;
            text-shadow: 0 0 10px #000;
            border-top: 1px solid rgb(200,250,100);
            font-size: 4vh;
            -webkit-box-shadow: rgba(255,255,255,.3) 0 2px 1px,rgba(0,0,0,.3) 0 -2px 1px, rgba(0,0,0,0.5) 0px 3px 10px, rgba(0,50,0,.75) 0 0 40px inset;
            -moz-box-shadow: rgba(255,255,255,.3) 0 2px 1px,rgba(0,0,0,.3) 0 -2px 1px, rgba(0,0,0,0.5) 0px 3px 10px, rgba(0,50,0,.75) 0 0 40px inset;
            box-shadow: rgba(255,255,255,.3) 0 2px 1px,rgba(0,0,0,.3) 0 -2px 1px, rgba(0,0,0,0.5) 0px 3px 10px, rgba(0,50,0,.75) 0 0 40px inset;
            background: #bfd255;
            background: -webkit-linear-gradient(top, #bfd255 0%, #8eb92a 50%, #72aa00 51%, #9ecb2d 100%);
            background: -moz-linear-gradient(top, #bfd255 0%, #8eb92a 50%, #72aa00 51%, #9ecb2d 100%);
            background: -o-linear-gradient(top, #bfd255 0%, #8eb92a 50%, #72aa00 51%, #9ecb2d 100%);
            background: linear-gradient(to bottom, #bfd255 0%, #8eb92a 50%, #72aa00 51%, #9ecb2d 100%);
        }

        .modalBtn.small {
            font-size: 2vw;
        }

        a:active { /* ??? */
            position: relative;
            top: 3px;
        }

        .fade-in { /* Used to fade in the banner when changing to a new phase */
            animation: fadeIn ease 2s;
            -webkit-animation: fadeIn ease 2s;
            -moz-animation: fadeIn ease 2s;
            -o-animation: fadeIn ease 2s;
        }

        @keyframes fadeIn {
            0% { opacity: 0; } 
            100% { opacity: 1; }
        }

        @-moz-keyframes fadeIn {
            0% { opacity: 0; } 
            100% { opacity: 1; }
        }

        @-webkit-keyframes fadeIn {
            0% { opacity: 0; } 
            100% { opacity: 1; }
        }

        @-o-keyframes fadeIn {
            0% { opacity: 0; } 
            100% { opacity: 1; }
        }

        @-ms-keyframes fadeIn {
            0% { opacity: 0; } 
            100% { opacity: 1; }
        }

        .fade-out { /* Used to fade out the banner when moving to a new step */
            animation: fadeOut ease 2s;
            -webkit-animation: fadeOut ease 2s;
            -moz-animation: fadeOut ease 28s;
            -o-animation: fadeOut ease 2s;
        }

        @keyframes fadeOut {
            0% { opacity: 1; } 
            100% { opacity: 0; }
        }

        @-moz-keyframes fadeOut {
            0% { opacity: 1; } 
            100% { opacity: 0; }
        }

        @-webkit-keyframes fadeOut {
            0% { opacity: 1; } 
            100% { opacity: 0; }
        }

        @-o-keyframes fadeOut {
            0% { opacity: 1; } 
            100% { opacity: 0; }
        }

        @-ms-keyframes fadeOut {
            0% { opacity: 1; } 
            100% { opacity: 0; }
        }
    </style>
    <style> /* Help */
        .help {
            position: fixed; /* Stay in place */
            z-index: 11; /* Sit on top of modal dialogue */
            left: 5vw;
            width: 90vw;
            top: 2vw;
            background: #909497;
        }

        #gameHelpHeader {
            margin-top: 7vh 0 10vh;
            color: #FFD700;
            font-size: 5vh;
            text-align: center;
            text-shadow: 0 0px 5px rgba(0,0,0,.25), 0 -1px 1px #000;
        }

        .help object {
            width: 90vw;
            height: 70vh;
        }

        .helpBtn {
            background: DarkTurquoise;
            display: block;
            padding: 2% 2%;
            border-radius: 12px;
            float: left;
            text-decoration: none;
            color: white;
            margin: 1px 1px 1px 1px;
            font-weight: bold;
            text-shadow: 0 0 10px #000;
            border-top: 1px solid rgb(200,250,100);
            font-size: 2vh;
            -webkit-box-shadow: rgba(255,255,255,.3) 0 2px 1px,rgba(0,0,0,.3) 0 -2px 1px, rgba(0,0,0,0.5) 0px 3px 5px, rgba(0,50,0,.75) 0 0 20px inset;
            -moz-box-shadow: rgba(255,255,255,.3) 0 2px 1px,rgba(0,0,0,.3) 0 -2px 1px, rgba(0,0,0,0.5) 0px 3px 5px, rgba(0,50,0,.75) 0 0 20px inset;
            box-shadow: rgba(255,255,255,.3) 0 2px 1px,rgba(0,0,0,.3) 0 -2px 1px, rgba(0,0,0,0.5) 0px 3px 5px, rgba(0,50,0,.75) 0 0 2 inset;
            background: #bfd255;
            background: -webkit-linear-gradient(top, #bfd255 0%, #8eb92a 50%, #72aa00 51%, #9ecb2d 100%);
            background: -moz-linear-gradient(top, #bfd255 0%, #8eb92a 50%, #72aa00 51%, #9ecb2d 100%);
            background: -o-linear-gradient(top, #bfd255 0%, #8eb92a 50%, #72aa00 51%, #9ecb2d 100%);
            background: linear-gradient(to bottom, #bfd255 0%, #8eb92a 50%, #72aa00 51%, #9ecb2d 100%);
        }
    </style>
    <style>
        #InfoArea {
            position: fixed;
            bottom: 0px;
            float: left;
            font-size: 1vw;
            z-index: 50;
        }

        #AboutArea {
            position: absolute;
            top: 15vh;
            left: 10vw;
            width: 80vw;
            text-align: center;
            font-size: 2vw;
            padding: 2vmax;
            color: white;
            background-color: SlateGray;
            z-index: 50;
        }

        #OptionsArea {
            position: absolute;
            top: 15vh;
            left: 10vw;
            width: 80vw;
            text-align: center;
            font-size: 3vw;
            padding: 2vmax;
            color: white;
            background-color: rgb(181, 91, 91);
            z-index: 50;
        }

        .optionSet {
            border: 2px solid white;
            margin: 1vmin;
            padding: 2vh;
        }
    </style>
</head>
<body>
    <div class="BackgroundContainer">
        <div class="fixed bg_1"></div>
        <div class="fixed bg_2"></div>
        <div class="fixed bg_3"></div>
        <div class="fixed bg_4"></div>
        <div class="fixed bg_5"></div>
        <div class="fixed bg_6"></div>
    </div>
    <div id="SequenceArea">
        <div id='gameOutline' class='bordered'></div>
    </div>
    <div id='SideNavLeft'>
        <div onclick='newgame_verify()'><a href='#' id='newGame'>New Game</a></div>
        <div class='hidden'><a href='#' id='back'></a></div>
        <div class='hidden'><a href='#' id='skip'></a></div>
        <div class='hidden'><a href='#' id='elim'></a></div>
        <div class='hidden'><a href='#' id='vp'></a></div>
    </div>
    <div id='SideNavRight'>
        <div onclick='showOptions()'><a href='#' id='options'>Options</a></div>
        <div onclick='showAbout()'><a href='#' id='about'>About</a></div>
    </div>
    <div id='GameModal' class='modal'>
        <div class='modal-content'>
            <div class='modalBanner'>banner: round information goes here</div>
            <div class='modalChangeBanner'>banner: phase change information goes here</div>
            <span id='modalClose' class='closeBtn'>&times;</span>
            <h1>header: phase information goes here</h1>
            <p>detail: step information goes here</p>
            <div class='modalButtonsArea buttonHolder'></div>
        </div>
        <div id='GameHelp' class='help'>
            <div id='gameHelpHeader'>
                <span class='closeBtn' onclick='GameHelp.classList.add("hidden")'>&times;</span>
                <p>step name goes here</p>
            </div>
            <div id='gameHelpDisplay'></div>
        </div>
    </div>
    <div id='InfoArea'></div>
    <div id='AboutArea' class='hidden'>
        <span style='vertical-align:middle'>
            The GameTracker webpage is property of Clive Pottinger. Email any comments or concerns to terran.antipodes@gmail.com<br />
            All displayed images, arts, fonts and The Lord of The Rings: The Card Game are copyrighted at � Fantasy Flight Games. The copyrightable portions of The Lord of the Rings: The Card Game and its expansions are � 2011 - 2020 Fantasy Flight Publishing, Inc. The Lord of the Rings, and the characters, items, events and places therein are trademarks or registered trademarks of The Saul Zaentz Company / Middle-earthEnterprises and are used, under license, by Fantasy Flight Games. Living Card Game, LCG, LCG logo and FantasyFlight Supply are trademarks and/or registered trademarks of Fantasy Flight Publishing, Inc. All Rights Reserved to their respective owners.<br />
            The Rules Compendium and Rules Companion are the intellectual property of, and used by permission by, Mathieu Martin.
        </span>
    </div>
    <div id='OptionsArea' class='hidden'>
        <form name='options'>
        <div class='optionSet'>Display the Compendium Rules as
            <label class='choiceHolder' onclick='CompendiumAsHtml=true'>HTML
                <input type='radio' name='compendiumAs'>
                <span class='indicator'></span>
            </label>
            <label class='choiceHolder' onclick='CompendiumAsHtml=false'>PDF
                <input type='radio' name='compendiumAs'>
                <span class='indicator'></span>
            </label>
        </div>
        </form>
    </div>
    <script>
        var version = 'v1.3.0';

        /* define game steps */
        var sequence = JSON.parse(
            '{ "phases": [ "Setup", "Resource", "Planning", "Quest", "Travel", "Encounter", "Combat", "Refresh" ] ' +
            // boxes format (in px): [left, top, right, bottom] or [initialplayerbox, subsequentplayerbox, finalplayerbox]
            // help format: [compendium_info, companion_info, action_window_info]
            //              compendium_info: [page number, pdf horiz offset, pdf offset, html jump index, html highlight index]
            //              companion_info:  [page number]
            //   (optional) compendium_info: [page number, pdf horiz offset, pdf offset, html jump index, html highlight index]
            // gameloop: value indicates the last step in the loop. After that step, the tracker will increment the round and loop back to this step.
            // teamloop: value indicates the last step in each player's steps. After that step, the tracker will switch to the next player and loop back to this step, or, if the player was the last player, continue to the next step.
            // teamskip: value indicates prompt and next step for all players if the fist player opts to skip.
            // playerskip: value indicates prompt. If the player opts to skip, then the tracter will switch to the next player and loop back to this step, or, if the player was the last player, continue to the next step.
            ' ,"steps": [ { "phase": 0, "name": "Extract Campaign Setup cards" } ' +
            '            ,{ "phase": 0, "name": "Shuffle Player Decks", "help" : [[47,0,135,1,1],[209]] } ' +
            '            ,{ "phase": 0, "name": "Shuffle Encounter Deck", "help" : [[47,0,130],[209]] } ' +
            '            ,{ "phase": 0, "name": "Place Heroes", "help" : [[47,0,400],[210]] } ' +
            '            ,{ "phase": 0, "name": "Perform Campaign Setup", "help" : [[47,0,700],[210]] } ' +
            '            ,{ "phase": 0, "name": "Set Threat Levels", "help" : [[47,0,400],[210]] } ' +
            '            ,{ "phase": 0, "name": "Create Token Banks", "help" : [[47,500,305],[211]] } ' +
            '            ,{ "phase": 0, "name": "Determine First Player", "help" : [[47,500,380],[212]] } ' +
            '            ,{ "phase": 0, "name": "Draw Starting Hand", "help" : [[47,500,455],[213]] } ' +
            '            ,{ "phase": 0, "name": "Place Quest Cards", "help" : [[47,500,555],[214]] } ' +
            '            ,{ "phase": 0, "name": "Perform Scenario Setup", "help" : [[47,500,650],[215]] } ' +
            '            ,{ "phase": 1, "name": "Gather Resources", "gameloop" : "Pass First Player Token", "boxes" : [60,75,490,190], "help" : [[48,0,510],[217]] }' +
            '            ,{ "phase": 1, "name": "Draw a Card", "actionwindow" : "true", "boxes" : [60,190,490,310], "help" : [[48,0,620],[217],[128,400]] } ' +
            '            ,{ "phase": 2, "name": "Special Action Window", "teamloop" : "Special Action Window", "boxes" : [[60,465,490,685],[60,525,490,685],[60,525,490,740]], "help" : [[48,0,710],[218],[128,600]] } ' +
            '            ,{ "phase": 3, "name": "Quest Action Window", "boxes" : [60,840,490,960], "help" : [[],[218],[128,920]] } ' +
            '            ,{ "phase": 3, "name": "Commit Characters", "actionwindow" : "true", "boxes" : [60,960,490,1080], "help" : [[48,500,100],[220],[129,50]] } ' +
            '            ,{ "phase": 3, "name": "Staging", "teamloop" : "Staging", "boxes" : [60,1080,490,1135], "help" : [[48,500,380],[221]] } ' +
            '            ,{ "phase": 3, "name": "Staging Action Window", "boxes" : [60,1135,490,1195], "help" : [[48,500,380],[221],[129,280]] } ' +
            '            ,{ "phase": 3, "name": "Quest Resolution", "actionwindow" : "true", "boxes" : [60,1195,490,1315], "help" : [[48,500,825],[222],[129,420]] } ' +
            '            ,{ "phase": 4, "name": "Travel Opportunity", "actionwindow" : "true", "boxes" : [60,1530,490,1645], "help" : [[49,500,100],[227],[129,725]] } ' +
            '            ,{ "phase": 5, "name": "Optional Engagement", "actionwindow" : "true", "boxes" : [60,1860,490,1980], "help" : [[49,500,750],[232],[129,910]] } ' +
            '            ,{ "phase": 5, "name": "Engagement Checks", "actionwindow" : "true", "boxes" : [60,1980,490,2100], "help" : [[50,0,50],[233],[129,980]] } ' +
            '            ,{ "phase": 6, "name": "Combat Check", "teamskip" : ["No Combat?", "Ready All Cards"], "boxes" : [60,2215,490,2320] } ' +
            '            ,{ "phase": 6, "name": "Deal Shadow Cards", "actionwindow" : "true", "teamskip" : ["No Enemies Are Attacking Players?", "Choose Enemy and Attackers"], "teamloop" : "Deal Shadow Cards", "boxes" : [60,2320,490,2428], "help" : [[50,0,845],[237],[130,130]] } ' +
            '            ,{ "phase": 6, "stage": "Enemy Attack", "name": "Choose Attacking Enemy", "actionwindow" : "true", "playerskip" : "Player Is Not Under Attack?", "teamloop" : "Determine Enemy and Defender Combat Damage", "boxes" : [[60,2428,490,2675],[60,2480,490,2675]], "help" : [[50,500,150],[238],[130,270]] } ' +
            '            ,{ "phase": 6, "stage": "Enemy Attack", "name": "Declare Defender", "actionwindow" : "true", "boxes" : [60,2675,490,2795], "help" : [[50,500,190],[238],[130,410]] } ' +
            '            ,{ "phase": 6, "stage": "Enemy Attack", "name": "Reveal & Resolve Shadow Effects", "actionwindow" : "true", "boxes" : [60,2795,490,2915], "help" : [[50,500,300],[238],[130,535]] } ' +
            '            ,{ "phase": 6, "stage": "Enemy Attack", "name": "Determine Enemy and Defender Combat Damage", "actionwindow" : "true", "boxes" : [60,2915,490,3035], "help" : [[50,0,340],[238],[130,730]] } ' +
            '            ,{ "phase": 6, "stage": "Player Attack", "name": "Choose Enemy and Attackers", "actionwindow" : "true", "playerskip" : "Player Is Not Attacking An Enemy?", "teamloop" : "Determine Attacker and Enemy Combat Damage", "boxes" : [0,3330,470,3585], "help" : [[51,0,290],[240],[131,85]] } ' +
            '            ,{ "phase": 6, "stage": "Player Attack", "name": "Determine Attacker Strength", "actionwindow" : "true" , "boxes" : [0,3585,470,3705], "help" : [[51,0,345],[240],[131,160]] } ' +
            '            ,{ "phase": 6, "stage": "Player Attack", "name": "Determine Attacker and Enemy Combat Damage", "actionwindow" : "true", "boxes" : [0,3705,470,3825], "help" : [[51,0,390],[240],[131,350]] } ' +
            '            ,{ "phase": 6, "name": "Discard All Shadow Cards", "boxes" : [0,4060,470,4110], "help" : [[51,0,860],[],[131,510]] } ' +
            '            ,{ "phase": 7, "name": "Ready All Cards", "boxes" : [0,4265,470,4320], "help" : [[52,500,315],[255],[]] } ' +
            '            ,{ "phase": 7, "name": "Raise Threat Levels", "boxes" : [0,4325,470,4380], "help" : [[52,500,315],[255],[]] } ' +
            '            ,{ "phase": 7, "name": "Pass First Player Token", "actionwindow" : "true", "boxes" : [0,4380,470,4500], "help" : [[52,500,315],[255],[]] } ' +
            '           ]' +
            ' ,"areas": [ { "name": "RESOURCE & PLANNING" ' +
            '              ,"voffset": 0 ' +
            '              ,"images": [ "https://images-cdn.fantasyflightgames.com/filer_public/bc/46/bc4690f5-b669-400b-bc4f-6e92cb813451/mec16_preview.jpg" ' +
            '                          ,"https://images-cdn.fantasyflightgames.com/filer_public/e4/a5/e4a52d3a-5484-492f-a628-6948e65fe26f/jme07_preview1.jpg" ' +
            '                          ,"https://images-cdn.fantasyflightgames.com/filer_public/c8/7e/c87eb0e6-2b62-442b-b151-157b73c9d310/ffi-preview.jpg" ' +
            '                          ,"https://images-cdn.fantasyflightgames.com/filer_public/0c/29/0c29b8cc-3f7a-4a90-a063-64576995a29d/mec32_one-ring_preview.jpg" ' +
            '                          ,"https://images-cdn.fantasyflightgames.com/filer_public/bc/28/bc28f1d8-cfab-489b-bbe4-b0704715f471/mec34_preview.jpg" ' +
            '                         ] ' +
            '             } ' +
            '            ,{ "name": "QUEST & TRAVEL" ' +
            '              ,"voffset": 777 ' +
            '              ,"images": [ "https://images-cdn.fantasyflightgames.com/filer_public/c8/03/c80313c8-af07-43f8-af92-d6fb8cda51c2/kn22_preview.jpg" ' +
            '                          ,"https://images-cdn.fantasyflightgames.com/filer_public/03/89/0389ccb0-5fc0-4027-bc00-5bbc4d26882e/mec86_preview1.jpg" ' +
            '                          ,"https://images-cdn.fantasyflightgames.com/filer_public/b7/1f/b71f7ce7-d492-46ec-878f-6d245f99e077/mec56-preview2.jpg" ' +
            '                          ,"https://images-cdn.fantasyflightgames.com/filer_public/bc/0d/bc0dda1d-5722-4f61-abe0-60b868665aa2/umen43_growing-stench-art.jpg" ' +
            '                          ,"https://images-cdn.fantasyflightgames.com/filer_public/a1/a3/a1a30a48-11f9-4c61-8a35-e7a5eeff823a/umen35-palace-ruins-art.jpg" ' +
            '                          ,"https://images-cdn.fantasyflightgames.com/filer_public/69/76/697670b3-9205-4cd6-b2f3-16f974b5d17c/mec62_art_cracks-of-doom.png" ' +
            '                          ,"https://images-cdn.fantasyflightgames.com/filer_public/e4/2f/e42f7766-9576-40f9-a04b-913bcad74fb6/jme01_preview_7.jpg" ' +
            '                         ] ' +
            '             } ' +
            '            ,{ "name": "ENCOUNTER" ' +
            '              ,"voffset": 1740 ' +
            '              ,"images": [ "https://images-cdn.fantasyflightgames.com/filer_public/cf/62/cf622e9b-9e77-40c2-98be-5a8c27a8f745/mec01_step_01.jpg" ' +
            '                          ,"https://images-cdn.fantasyflightgames.com/filer_public/47/df/47df5db1-b712-489e-9dd3-67f71becbb73/mec01_step_02.jpg" ' +
            '                          ,"https://images-cdn.fantasyflightgames.com/filer_public/3c/84/3c849cf3-e3b0-48ec-bd5f-312178c7974f/jme03-04_preview2.jpg" ' +
            '                          ,"https://images-cdn.fantasyflightgames.com/filer_public/dc/ef/dcefcd54-6869-419b-9a42-8edd87dc47df/umen35-shadow-the-orcs-art.jpg" ' +
            '                          ,"https://images-cdn.fantasyflightgames.com/filer_public/aa/40/aa40ab22-6d12-469e-9be4-89e57dc6a5ad/umec84-85_preview1.jpg" ' +
            '                          ,"https://images-cdn.fantasyflightgames.com/filer_public/51/23/512344fe-ba2a-493f-a051-cfee98d40c44/umen37-39_art_forced-off-track.png" ' +
            '                          ,"https://images-cdn.fantasyflightgames.com/filer_public/09/59/09593360-9add-4e04-aa8b-e242fb93f68b/umen28_preview.jpg" ' +
            '                          ,"https://images-cdn.fantasyflightgames.com/filer_public/4f/e0/4fe0002f-3fd3-463b-8000-4b01ee45d992/mes01-05_preview1.png" ' +
            '                         ] ' +
            '             } ' +
            '            ,{ "name": "ENEMY ATTACK" ' +
            '              ,"voffset": 2195 ' +
            '              ,"images": [ "https://images-cdn.fantasyflightgames.com/filer_public/00/6e/006e18e0-cd00-4083-9ce6-42ead3f90f05/jme01_preview_1.jpg" ' +
            '                          ,"https://images-cdn.fantasyflightgames.com/filer_public/10/3d/103d50a4-2789-4e99-91d0-5cb1e8e20f46/umen43_wicked-hobbits-art.jpg" ' +
            '                          ,"https://images-cdn.fantasyflightgames.com/filer_public/3e/c5/3ec56810-9135-4d9e-ad9b-63b041398aad/umen36_preview.png" ' +
            '                          ,"https://images-cdn.fantasyflightgames.com/filer_public/3a/42/3a42f3c8-58da-45f9-b081-39329b5a5aca/umen20-34_preview.png" ' +
            '                          ,"https://images-cdn.fantasyflightgames.com/filer_public/b1/5d/b15d737a-8382-4e29-b746-9e65b3663fc9/mec54-city-besieged-art.jpg" ' +
            '                          ,"https://images-cdn.fantasyflightgames.com/filer_public/54/2d/542d8e96-93dd-444f-b04c-2a4a1af0a8c1/mec101_announcement_preview.png" ' +
            '                         ] ' +
            '             } ' +
            '            ,{ "name": "PLAYER ATTACK" ' +
            '              ,"voffset": 3281 ' +
            '              ,"images": [ "https://images-cdn.fantasyflightgames.com/filer_public/6b/ab/6baba999-f2ff-492f-abd1-ad9893f1556e/mec_fellowship_2017_art_battle.png" ' +
            '                          ,"https://images-cdn.fantasyflightgames.com/filer_public/ed/cc/edcc9c29-9bfa-4e25-b6ae-8e339893005a/fellowship2015_preview1.jpg" ' +
            '                          ,"https://images-cdn.fantasyflightgames.com/filer_public/4e/5a/4e5a5a48-7678-45d2-bce0-a5c10bab1546/mec_fellowship_2017_art_siege.png" ' +
            '                          ,"https://images-cdn.fantasyflightgames.com/filer_public/54/d8/54d87a57-b29c-4d7f-8951-2d94a676f902/umec64_coverart.jpg" ' +
            '                         ] ' +
            '             } ' +
            '            ,{ "name": "REFRESH" ' +
            '              ,"voffset": 4145 ' +
            '              ,"images": [ "https://images-cdn.fantasyflightgames.com/filer_public/bd/7c/bd7cf918-9c0f-4010-aff9-417431615ce7/mec01_step_00.jpg" ' +
            '                          ,"https://images-cdn.fantasyflightgames.com/filer_public/8f/66/8f66dc61-addd-4d8a-9a07-42f070536499/mec08_preview.jpg" ' +
            '                          ,"https://images-cdn.fantasyflightgames.com/filer_public/28/53/28531b9e-a3f6-4c50-a1ec-39899ac073cb/mec17_preview.jpg" ' +
            '                          ,"https://images-cdn.fantasyflightgames.com/filer_public/b4/3f/b43f119e-4850-44f5-b8c7-c21b1f2c1174/umen47_art_desecrated-pavilion.png" ' +
            '                          ,"https://images-cdn.fantasyflightgames.com/filer_public/58/b5/58b54268-64b1-441b-a007-e2686e9e89e6/jme01_preview_5.png" ' +
            '                         ] ' +
            '             } ' +
            '            ,{ "name": "END" ' +
            '              ,"voffset": 4594 ' +
            '              ,"images": [""] ' +
            '             } ' +
            '           ]' +
            '}'
        );

        const ALLPLAYERS = 0; // player number used when a step is performed by all players

        /* define state encoding values (see https://clivesyabb.com/2021/10/01/encoding-multiple-values-in-a-single-number/) */
        const PLAYER_EVS = { cram: 2057566, extract: 5 };
        const PLAYERS_EVS = { cram: -734845, extract: 7 };
        const STEP_EVS = { cram: 1422785, extract: 47 };
        const ROUND_EVS = { cram: -2135210, extract: 53 };
        const VP_EVS = { cram: -610295, extract: 59 };

        /* define webpage constants */
        const BACKGROUND_CONTAINER = document.getElementsByClassName('BackgroundContainer')[0];
        const SEQUENCE_AREA = document.getElementById('SequenceArea');
        const NAV_BACK = document.getElementById('back');
        const NAV_SKIP = document.getElementById('skip');
        const NAV_ELIM = document.getElementById('elim');
        const NAV_VP = document.getElementById('vp');
        const MODAL_DIALOGUE = document.getElementById('GameModal');
        const MODAL_BANNER = MODAL_DIALOGUE.getElementsByClassName('modalBanner')[0];
        const MODAL_CHANGE_BANNER = MODAL_DIALOGUE.getElementsByClassName('modalChangeBanner')[0];
        const MODAL_HEADER = MODAL_DIALOGUE.getElementsByTagName('h1')[0];
        const MODAL_DETAIL = MODAL_DIALOGUE.getElementsByTagName('p')[0];
        const MODAL_CLOSE = document.getElementById('modalClose');
        const MODAL_BUTTONS_AREA = MODAL_DIALOGUE.getElementsByClassName('modalButtonsArea')[0];
        const GAME_OUTLINE = document.getElementById('gameOutline');
        const GAME_HELP = document.getElementById('GameHelp');
        const GAME_HELP_HEADER = document.getElementById('gameHelpHeader');
        const GAME_HELP_TEXT = GAME_HELP_HEADER.getElementsByTagName('p')[0];
        const GAME_HELP_DISPLAY = document.getElementById('gameHelpDisplay');
        const INFO_AREA = document.getElementById('InfoArea');
        const ABOUT_AREA = document.getElementById('AboutArea');
        const OPTIONS_AREA = document.getElementById('OptionsArea')

        /* Define webpage globals */
        var SequenceImage;
        var SequenceImageSize;
        var CompendiumIsPreferred = true;
        var CompendiumAsHtml = true;
    </script>
    <script>
        /* main code */
        INFO_AREA.innerHTML = version;
        loadBackground('./Images/RoundSequence.png');

        function loadBackground(url) {
            const img = new Image();
            img.addEventListener('load', function () {
                SequenceImageSize = [this.naturalHeight, this.naturalWidth];
                // once the background is loaded, then the rest of the page can be set up.
                SEQUENCE_AREA.appendChild(img);
                SequenceImage = SEQUENCE_AREA.getElementsByTagName('img')[0];
                initialize();
            });
            img.src = url;
        }

        function initialize() {
            NAV_BACK.parentElement.classList.add('hidden');
            MODAL_BANNER.classList.add('hidden');
            MODAL_CHANGE_BANNER.classList.add('hidden');
            MODAL_CHANGE_BANNER.innerHTML = '';
            GAME_HELP.classList.add('hidden');
            GAME_OUTLINE.classList.add('hidden');

            // set the background images and size them so that, when scrolling down, each image appears behind the corresponding area of the sequence.
            var bounds = SequenceImage.getBoundingClientRect();
            var vscale = bounds.height / SequenceImageSize[0]; // vscale: 1px of the sequence image is being rendered as ?px high onscreen
            var offset = SEQUENCE_AREA.offsetTop
            var images = BACKGROUND_CONTAINER.getElementsByClassName('fixed');
            for (var index = 0; index < images.length; index++) {
                var imageTop = sequence.areas[index].voffset;
                var imageBottom = sequence.areas[index + 1].voffset;
                images[index].style.height = offset + (imageBottom - imageTop) * vscale + 'px';
                var selection = modulo(Math.floor(Date.now() / 86400000), sequence.areas[index].images.length);
                images[index].style.backgroundImage = "url('" + sequence.areas[index].images[selection] + "')";
                images[index].style.backgroundSize = "cover";
                offset = 0;
            }

            // translate the step names that define loops into step numbers
            for (var step = 0; step < sequence.steps.length; step++) {
                if (sequence.steps[step].gameloop) {
                    var gameloopend = findStepNum(sequence.steps[step].gameloop);
                    sequence.steps[step].gameloopend = gameloopend;
                    sequence.steps[gameloopend].gameloopstart = step;
                }
                if (sequence.steps[step].teamloop) {
                    var teamloopend = findStepNum(sequence.steps[step].teamloop);
                    sequence.steps[step].teamloopend = teamloopend;
                    sequence.steps[teamloopend].teamloopstart = step;
                }
                if (sequence.steps[step].teamskip) {
                    sequence.steps[step].skipto = findStepNum(sequence.steps[step].teamskip[1]);
                }
            }

            var stateHistory = localStorage.getItem('stateHistory');
            if (stateHistory) {
                var optionsVal =  Number(stateHistory.split(',').at(-1));
                if ((optionsVal > 0) && (optionsVal < 256)) {
                    CompendiumIsPreferred = ((optionsVal & 1) == 1);
                    CompendiumAsHtml = ((optionsVal & 2) == 2);
                }

                var initialState = Number(stateHistory.split(',')[0]);
                game_setCurrentState(initialState, true);
            }
        }

        function newgame_verify() { // Open modal dialogue to verify a new game is starting
            var closeInfo = '(press &times; to return without starting a new game)';
            var prompt = 'How many players in the new game?';
            var buttons = [];
            for (var x = 1; x < 5; x++) {
                buttons[x] = generateButton('&nbsp;' + x + '&nbsp;', 'newgame_start(' + x + ')');
            }

            showModal('', closeInfo, true, prompt, '', buttons);
        }

        function newgame_start(numPlayers) { // Resets the page for a new game
            localStorage.removeItem('stateHistory');
            var initialState = numPlayers * PLAYERS_EVS.cram;
            localStorage.setItem('stateHistory', initialState.toString());
            recordOptions();
            game_advanceToStep(0, ALLPLAYERS);
        }

        function game_advanceToStep(newStepNum, newPlayer = null, newRound = null) { // shows the modal dialogue information for a step in the game
            // At this point we have not yet changed our state to be in the new step.
            // We are gathering information about the current state we are moving from and the new state we are move to.
            var stateHistory = localStorage.getItem('stateHistory');
            var fromState = parseInt(stateHistory.split(',')[0], 10);

            var fromRound = modulo(fromState, ROUND_EVS.extract);
            var fromPlayer = modulo(fromState, PLAYER_EVS.extract);
            var fromNumPlayers = modulo(fromState, PLAYERS_EVS.extract);
            var fromVictoryPoints = modulo(fromState, VP_EVS.extract);

            var toRound = (newRound == null) ? fromRound : newRound;
            var toStepNum = newStepNum;
            var toStep = sequence.steps[newStepNum];
            var toPlayer = (newPlayer == null) ? fromPlayer : newPlayer;
            var toNumPlayers = fromNumPlayers;
            var toVictoryPoints = fromVictoryPoints;

            // check if we starting new loop
            if ((toPlayer == ALLPLAYERS) && (toStep.teamloop)) {
                toPlayer = 1;
            }

            var newState =
                toRound * ROUND_EVS.cram +
                toStepNum * STEP_EVS.cram +
                toPlayer * PLAYER_EVS.cram +
                toNumPlayers * PLAYERS_EVS.cram +
                toVictoryPoints * VP_EVS.cram;

            // var fromStepNum = modulo(fromState, STEP_EVS.extract);
            // var fromStep = sequence.steps[fromStepNum];
            // var fromPhaseNum = fromStep.phase;
            // var toPhaseNum = toStep.phase;
            // console.log('advanceToStep -> round:' + fromRound + '->' + toRound +
            //             ' phase:' + fromPhaseNum + '->' + toPhaseNum +
            //             ' step:' + fromStepNum + '->' + toStepNum + ' (' + sequence.steps[toStepNum].name + ')' +
            //             ' player:' + fromPlayer + '->' + toPlayer +
            //             ' # players:' + fromNumPlayers + '->' + toNumPlayers +
            //             ' points:' + fromVictoryPoints + '->' + toVictoryPoints +
            //             '');

            game_setCurrentState(newState);
        }

        function game_backToPreviousStep() {
            var stateHistory = localStorage.getItem('stateHistory');
            var toState = parseInt(stateHistory.split(',')[1], 10); // go back 2 states in the history because we have already added the current state to the history
            localStorage.setItem('stateHistory', stateHistory.slice(stateHistory.split(',', 3).join(',').length + 1)); // removes the first two states from the history

            // var fromState = parseInt(stateHistory.split(',')[0], 10);
            // var fromStepNum = modulo(fromState, STEP_EVS.extract);
            // var fromStep = sequence.steps[fromStepNum];
            // var fromRound = modulo(fromState, ROUND_EVS.extract);
            // var fromPhaseNum = fromStep.phase;
            // var fromPlayer = modulo(fromState, PLAYER_EVS.extract);
            // var fromNumPlayers = modulo(fromState, PLAYERS_EVS.extract);
            // var fromVictoryPoints = modulo(fromState, VP_EVS.extract);
            // var toStepNum = modulo(toState, STEP_EVS.extract);
            // var toStep = sequence.steps[toStepNum];
            // var toRound = modulo(toState, ROUND_EVS.extract);
            // var toPhaseNum = toStep.phase;
            // var toPlayer = modulo(toState, PLAYER_EVS.extract);
            // var toNumPlayers = modulo(toState, PLAYERS_EVS.extract);
            // var toVictoryPoints = modulo(toState, VP_EVS.extract);
            // console.log('backToPreviousStep -> round:' + fromRound + '->' + toRound +
            //             ' phase:' + fromPhaseNum + '->' + toPhaseNum +
            //             ' step:' + fromStepNum + '->' + toStepNum + ' (' + sequence.steps[toStepNum].name + ')' +
            //             ' player:' + fromPlayer + '->' + toPlayer +
            //             ' # players:' + fromNumPlayers + '->' + toNumPlayers +
            //             ' points:' + fromVictoryPoints + '->' + toVictoryPoints +
            //             '');

            game_setCurrentState(toState);
        }

        function game_setCurrentState(currentState, isRefresh = false) {
            var stateHistory = localStorage.getItem('stateHistory');
            if (!isRefresh) {
                localStorage.setItem('stateHistory', currentState + ',' + stateHistory);
            }

            var previousState = parseInt(stateHistory.split(',')[0], 10);

            var currentStepNum = modulo(currentState, STEP_EVS.extract);
            var currentStep = sequence.steps[currentStepNum];
            var currentPhaseNum = currentStep.phase;
            var currentPlayer = modulo(currentState, PLAYER_EVS.extract);
            var currentNumPlayers = modulo(currentState, PLAYERS_EVS.extract);
            var currentRound = modulo(currentState, ROUND_EVS.extract);
            // console.log('setCurrentState -> set current -> round:' + currentRound  +
            //              ' phase:' + currentPhaseNum +
            //              ' step:' + currentStepNum + ' (' + sequence.steps[currentStepNum].name + ')' +
            //              ' player:' + currentPlayer +
            //              ' # players:' + currentNumPlayers +
            //              '');

            var bannerInfo = game_setStandardBanners(currentState, previousState);
            var banner = bannerInfo[0];
            var changeBanner = bannerInfo[1];
            var showClose = bannerInfo[2];
            var header = bannerInfo[3];

            var isALLPLAYERS = (currentPlayer == ALLPLAYERS);
            var isFirstPlayer = (currentPlayer == 1);
            var isLastPlayer = (currentPlayer == currentNumPlayers);

            var nextStepNum = currentStepNum + 1;
            var nextPlayer = currentPlayer;
            var nextRound = currentRound;
            switch (true) {
                case (currentStep.teamloopstart != null):
                    nextStepNum = (isLastPlayer) ? currentStepNum + 1 : currentStep.teamloopstart;
                    nextPlayer = (isLastPlayer) ? ALLPLAYERS : currentPlayer + 1;
                    break;
                case (currentStep.gameloopstart != null):
                    nextStepNum = currentStep.gameloopstart;
                    nextPlayer = ALLPLAYERS;
                    nextRound = currentRound + 1;
                    break;
            }

            // text: shows the current step
            var hasActionWindow = currentStep.actionwindow;
            var detail = ((currentStep.name.includes('Action Window')) ? '<span style="color:SpringGreen">' + currentStep.name + '<step>' : currentStep.name) +
                (hasActionWindow ? '<br>&amp;<br><span style="color:SpringGreen">Action Window</span>' : '');
            if (!isALLPLAYERS) { // are we inside a loop?
                detail = (isFirstPlayer ? 'First Player' : 'Player ' + currentPlayer) + ': ' + detail;
            }

            // buttons
            var buttons = [];
            buttons.push(generateButton('Next', 'game_advanceToStep(' + nextStepNum + ',' + nextPlayer + ',' + nextRound + ')'));
            if (currentStep.help) {
                buttons.push(generateButton('Help', 'game_showHelp("' + currentStep.name + '",' + JSON.stringify(currentStep.help) + ')'));
            }

            // SideNav: back
            var showBack = (currentPhaseNum > 0);

            // SideNav: skip
            var skipInfo = null;
            switch (true) {
                case ((currentStep.teamskip != null) && (isALLPLAYERS || isFirstPlayer)):
                    skipInfo = [currentStep.teamskip[0], currentStep.skipto, ALLPLAYERS];
                    break;
                case (currentStep.playerskip != null):
                    var skiptoStepNum = (isLastPlayer) ? currentStep.teamloopend + 1 : currentStepNum;
                    var skiptoPlayer = (isLastPlayer) ? ALLPLAYERS : currentPlayer + 1;
                    skipInfo = [currentStep.playerskip, skiptoStepNum, skiptoPlayer];
                    break;
            }

            // SideNav: eliminate player
            var showElim = ((currentNumPlayers > 1) && (currentPhaseNum > 0));

            // SideNav: victory points
            var showVP = (currentPhaseNum > 0);

            var sideNavInfo = [showBack, skipInfo, showElim, showVP];

            // repositioning of the background image
            var box;
            switch (true) {
                case (currentStep.boxes == null):
                    box = null;
                    break;
                case (currentStep.boxes.length == 4):
                    box = currentStep.boxes;
                    break;
                case (isALLPLAYERS || isFirstPlayer):
                    box = currentStep.boxes[0];
                    break;
                case (isLastPlayer):
                    box = currentStep.boxes[currentStep.boxes.length - 1];
                    break;
                default:
                    box = currentStep.boxes[1];
                    break;
            }

            sleep(250).then(() => {
                showModal(banner, changeBanner, showClose, header, detail, buttons, sideNavInfo, box);
            });
        }

        function game_setStandardBanners(currentState, previousState) {
            var previousStepNum = modulo(previousState, STEP_EVS.extract);
            var previousStep = sequence.steps[previousStepNum];
            var previousPhaseNum = previousStep.phase;

            var currentRound = modulo(currentState, ROUND_EVS.extract);
            var currentStepNum = modulo(currentState, STEP_EVS.extract);
            var currentStep = sequence.steps[currentStepNum];
            var currentPhaseNum = currentStep.phase;
            var currentNumPlayers = modulo(currentState, PLAYERS_EVS.extract);
            var currentVictoryPoints = modulo(currentState, VP_EVS.extract);

            // banner: shows the current round
            var banner = (currentRound == 0)
                ? ''
                : 'Round ' + currentRound +
                ((currentNumPlayers == 1) ? '' : ' (' + currentNumPlayers + ' players)') +
                ((currentVictoryPoints == 0) ? '' : ' VP: ' + currentVictoryPoints);

            // change banner: shows when the phase changes
            var isPhaseChange = (currentPhaseNum != previousPhaseNum);
            var changeBanner = (isPhaseChange)
                ? 'End of the ' + sequence.phases[previousPhaseNum] + ' Phase<br>' +
                'Start of the ' + sequence.phases[currentPhaseNum] + ' Phase'
                : '';

            // close button: shows only for the new game state
            var showClose = false;

            // header: shows the current phase and stage
            var header = sequence.phases[currentPhaseNum] + ' Phase' +
                ((currentStep.stage == null) ? '' : ': ' + currentStep.stage + ' Stage');

            return [banner, changeBanner, showClose, header];
        }

        function game_showHelp(stepText, helpLocations) {
            var compendiumInfo = helpLocations[0];
            var companionInfo = (helpLocations.length < 2) ? [] : helpLocations[1];
            var actionWindowInfo = (helpLocations.length < 3) ? [] : helpLocations[2];
            GAME_HELP_TEXT.innerHTML =
                stepText +
                '<div class="buttonHolder">' +
                ((compendiumInfo.length == 0) ? '' : generateButton('Compendium', 'CompendiumIsPreferred=true;game_showCompendium(' + JSON.stringify(compendiumInfo) + ')', 'helpBtn')) +
                ((companionInfo.length == 0) ? '' : generateButton('Companion', 'CompendiumIsPreferred=false;game_showCompanion(' + companionInfo[0] + ')', 'helpBtn')) +
                ((actionWindowInfo.length == 0) ? '' : generateButton('Action Window', 'game_showCompendium(' + JSON.stringify(actionWindowInfo) + ')', 'helpBtn')) +
                '</div>';

            if (CompendiumIsPreferred || (onlinePage = null)) {
                game_showCompendium(compendiumInfo[0], compendiumInfo[1], compendiumInfo[2]);
            } else {
                game_showCompanion(companionInfo[0]);
            }
        }

        function game_showCompendium(pageNum, hOffset, vOffset) {
            var pdfOptions = '#page=' + pageNum + '&zoom=100,' + hOffset + ',' + vOffset + '&pagemode=none&view=FitH';
            GAME_HELP_DISPLAY.innerHTML = "<object data='./Images/RulesCompendium_v2.0.pdf" + pdfOptions + " type='application/pdf'></object>";
            GAME_HELP.classList.remove('hidden');
        }

        function game_showCompendiumWebPage(pageNum, hOffset, vOffset) {
            var htmlOptions = '#' + pageNum + '_' + vOffset + '&pagemode=none&view=FitH';
            GAME_HELP_DISPLAY.innerHTML = "<object data='./RulesCompendium_v2.0/Rules_Compendium_v2_0.html'></object>";
            GAME_HELP.classList.remove('hidden');
        }

        function game_showCompanion(pageNum) {
            GAME_HELP_DISPLAY.innerHTML = "<object data='https://lotr-lcg-quest-companion.gamersdungeon.net/#Rule" + pageNum + "' type='text/html'></object>";
            GAME_HELP.classList.remove('hidden');
        }

        function game_verifyElimPlayer() {
            var stateHistory = localStorage.getItem('stateHistory');
            var currentState = parseInt(stateHistory.split(',')[0], 10);

            var previousState = parseInt(stateHistory.split(',')[1], 10);

            var currentRound = modulo(currentState, ROUND_EVS.extract);
            var currentStepNum = modulo(currentState, STEP_EVS.extract);
            var currentPlayer = modulo(currentState, PLAYER_EVS.extract);
            var currentNumPlayers = modulo(currentState, PLAYERS_EVS.extract);
            var currentVictoryPoints = modulo(currentState, VP_EVS.extract);

            var bannerInfo = game_setStandardBanners(currentState, previousState);
            var banner = bannerInfo[0];
            var changeBanner = bannerInfo[1];
            var showClose = bannerInfo[2];
            var header = bannerInfo[3];

            // text:
            var detail = 'Remove one Player?';

            // buttons
            var buttons = [];
            var newState =
                currentRound * ROUND_EVS.cram +
                currentStepNum * STEP_EVS.cram +
                currentPlayer * PLAYER_EVS.cram +
                (currentNumPlayers - 1) * PLAYERS_EVS.cram +
                currentVictoryPoints * VP_EVS.cram;
            buttons.push(generateButton('Yes', 'game_setCurrentState(' + newState + ')'));
            buttons.push(generateButton('No', 'game_setCurrentState(' + currentState + ',"true")'));

            // SideNav: back
            var showBack = false;

            // SideNav: skip
            var skipInfo = null;

            // SideNav: eliminate player
            var showElim = false;

            // SideNav: victory points
            var showVP = false;

            var sideNavInfo = [showBack, skipInfo, showElim, showVP];

            // repositioning of the background image
            var box = null;

            showModal(banner, changeBanner, showClose, header, detail, buttons, sideNavInfo, box);
        }

        function game_changeVP(newState = null) {
            var stateHistory = localStorage.getItem('stateHistory');
            var currentState = parseInt(stateHistory.split(',')[0], 10);

            if (newState == null) {
                newState = currentState;
            }

            var previousState = parseInt(stateHistory.split(',')[1], 10);

            // var newRound = modulo(newState, ROUND_EVS.extract);
            // var newStepNum = modulo(newState, STEP_EVS.extract);
            // var newPlayer = modulo(newState, PLAYER_EVS.extract);
            // var newNumPlayers = modulo(newState, PLAYERS_EVS.extract);
            var newVictoryPoints = modulo(newState, VP_EVS.extract);

            var bannerInfo = game_setStandardBanners(newState, previousState);
            var banner = bannerInfo[0];
            var changeBanner = bannerInfo[1];
            var showClose = bannerInfo[2];
            var header = bannerInfo[3];

            // text:
            var detail = 'Adjust Victory Points';

            // buttons
            var buttons = [];
            if (newVictoryPoints > 4) {
                buttons.push(generateButton('-5', 'game_changeVP(' + (newState - 5 * VP_EVS.cram) + ')', 'modalBtn small'));
            }
            if (newVictoryPoints > 0) {
                buttons.push(generateButton('-1', 'game_changeVP(' + (newState - VP_EVS.cram) + ')', 'modalBtn small'));
            }
            if (newState != currentState) {
                buttons.push(generateButton('Done', 'game_setCurrentState(' + newState + ')', 'modalBtn small'));
            }
            buttons.push(generateButton('+1', 'game_changeVP(' + (newState + VP_EVS.cram) + ')', 'modalBtn small'));
            buttons.push(generateButton('+5', 'game_changeVP(' + (newState + 5 * VP_EVS.cram) + ')', 'modalBtn small'));
            buttons.push(generateButton('Cancel', 'game_setCurrentState(' + currentState + ',"true")', 'modalBtn small'));

            // SideNav: back
            var showBack = false;

            // SideNav: skip
            var skipInfo = null;

            // SideNav: eliminate player
            var showElim = false;

            // SideNav: victory points
            var showVP = false;

            var sideNavInfo = [showBack, skipInfo, showElim, showVP];

            // repositioning of the background image
            var box = null;

            showModal(banner, changeBanner, showClose, header, detail, buttons, sideNavInfo, box);
        }

        function showModal(bannerText, changeBannerText, showClose, headerText, detailText, buttons, sideNavInfo, box = null) { // display the modal dialogue
            // banner:
            MODAL_BANNER.innerHTML = bannerText;
            if (bannerText == '') {
                MODAL_BANNER.classList.add('hidden');
            } else {
                MODAL_BANNER.classList.remove('hidden');
            }

            // change banner:
            if (MODAL_CHANGE_BANNER.innerHTML != changeBannerText) {
                MODAL_CHANGE_BANNER.classList.remove('fade-in', 'fade-out');
                if (changeBannerText == '') {
                    MODAL_CHANGE_BANNER.classList.add('fade-out');
                    MODAL_CHANGE_BANNER.addEventListener('animationend', clearModalChangeBanner);
                } else {
                    MODAL_CHANGE_BANNER.classList.add('hidden');
                    MODAL_CHANGE_BANNER.innerHTML = changeBannerText;
                    MODAL_CHANGE_BANNER.classList.add('fade-in');
                    MODAL_CHANGE_BANNER.classList.remove('hidden');
                }
            }
            function clearModalChangeBanner() {
                MODAL_CHANGE_BANNER.classList.add('hidden');
                MODAL_CHANGE_BANNER.innerHTML = '';
                MODAL_CHANGE_BANNER.removeEventListener('animationend', clearModalChangeBanner);
            }

            // close button:
            if (showClose) { // make the close <span> appear
                MODAL_CLOSE.style.display = 'block';
                MODAL_CLOSE.onclick = function () { // When the user clicks on <span> (x), close the modal dialogue
                    hideModal();
                    if (localStorage.getItem('stateHistory')) {
                        latestsState = parseInt(localStorage.getItem('stateHistory').split(',')[0], 10);
                        game_setCurrentState(latestsState);
                    }
                }
            } else { // hide the close <span>
                MODAL_CLOSE.style.display = 'none';
            }

            // header:
            MODAL_HEADER.innerHTML = headerText;

            // detail:
            MODAL_DETAIL.innerHTML = detailText;

            // buttons:
            MODAL_BUTTONS_AREA.innerHTML = '';
            buttons.forEach(b => MODAL_BUTTONS_AREA.innerHTML += b);

            // SideNavs:
            var showBack = (sideNavInfo == null) ? false : sideNavInfo[0];
            var skipInfo = (sideNavInfo == null) ? null : sideNavInfo[1];
            var showElim = (sideNavInfo == null) ? false : sideNavInfo[2]
            var showVP = (sideNavInfo == null) ? false : sideNavInfo[3];

            // SideNavs: back:
            if (showBack) {
                showSideNav(NAV_BACK, 'Back', function () { game_backToPreviousStep(); });
            } else {
                hideSideNav(NAV_BACK);
            }

            // SideNavs: skip:
            if (skipInfo == null) {
                hideSideNav(NAV_SKIP);
            } else {
                var skiptext = skipInfo[0];
                var skipToStepNum = skipInfo[1];
                var skipToPlayer = skipInfo[2];
                showSideNav(NAV_SKIP, skiptext, function () { game_advanceToStep(skipToStepNum, skipToPlayer); });
            }

            // SideNavs: eliminate player:
            if (showElim) {
                showSideNav(NAV_ELIM, 'Elimination', function () { game_verifyElimPlayer(); });
            } else {
                hideSideNav(NAV_ELIM);
            }

            // SideNavs: victory points:
            if (showVP) {
                showSideNav(NAV_VP, 'Points', function () { game_changeVP(); });
            } else {
                hideSideNav(NAV_VP);
            }

            MODAL_DIALOGUE.style.display = 'block';  // make the modal dialogue appear

            // background image and outlining box:
            // (this must be done AFTER the modal dialogue has been rendered)
            if (box == null) {
                GAME_OUTLINE.classList.add('hidden');
            } else {
                showOutline(box);
            }
        }

        function hideModal() { // hide the modal dialogue
            MODAL_DIALOGUE.style.display = 'none';
        }

        function showOutline(box) {
            var bounds = SequenceImage.getBoundingClientRect();
            var vscale = bounds.height / SequenceImageSize[0]; // factor: 1px of the sequence image is being rendered as ?px high onscreen
            var hscale = bounds.width / SequenceImageSize[1];  // factor: 1px of the sequence image is being rendered as ?px wide onscreen

            var modalBottom = Math.ceil(MODAL_DIALOGUE.offsetTop + MODAL_DIALOGUE.offsetHeight);
            var outlineOffset = Math.floor(Math.max(window.innerHeight / 20, 25)); // how many pixels from the bottom of the modal dialogue to where the current step will be shown.
            var sequenceAreaTargetOffset = Math.max((modalBottom + outlineOffset) - SEQUENCE_AREA.offsetTop, 0); // how many pixels from the top of the sequence image display area to where we want to scroll the current step to.

            // scroll the sequence image to show the current step under the modal dialogue
            var sequenceImageOffsetTop = Math.max(box[1] * vscale - sequenceAreaTargetOffset * vscale, 0);
            window.scrollTo({
                top: sequenceImageOffsetTop,
                left: 0,
                behavior: 'smooth'
            });

            var boxTop = box[1] * vscale; // as measured from the top of the sequence image on the current display
            var boxHeight = (box[3] - box[1]) * vscale;
            var boxWidth = (box[2] - box[0]) * hscale;

            GAME_OUTLINE.style.top = boxTop + 'px';
            GAME_OUTLINE.style.height = boxHeight + 'px';
            GAME_OUTLINE.style.width = boxWidth + 'px';
            GAME_OUTLINE.classList.remove('hidden');
        }

        function showSideNav(navElement, textContent, onclick) {
            navElement.innerHTML = textContent;
            navElement.parentElement.onclick = onclick;
            navElement.parentElement.classList.remove('hidden');
        }

        function hideSideNav(navElement) {
            navElement.innerHTML = '';
            navElement.parentElement.classList.add('hidden');
        }

        function showAbout() {            
            if (ABOUT_AREA.classList.contains('hidden')) {
                INFO_AREA.style.color = 'white';
                ABOUT_AREA.classList.add('fade-in');
                ABOUT_AREA.classList.remove('hidden');
                ABOUT_AREA.addEventListener('animationend',aboutFadeinDone);
            }    

            function aboutFadeinDone() {
                ABOUT_AREA.classList.remove('fade-in');
                ABOUT_AREA.removeEventListener('animationend',aboutFadeinDone);
                window.addEventListener('click', aboutUserClicked);
            }

            function aboutUserClicked(e) {
                window.removeEventListener('click', aboutUserClicked);
                ABOUT_AREA.classList.add('fade-out');
                ABOUT_AREA.addEventListener('animationend', aboutFadeoutDone);
            }
            
            function aboutFadeoutDone() {
                INFO_AREA.style.color = 'black';
                ABOUT_AREA.classList.add('hidden');
                ABOUT_AREA.classList.remove('fade-out');
                ABOUT_AREA.removeEventListener('animationend', aboutFadeoutDone);
            }
        }

        function showOptions() {
            if (OPTIONS_AREA.classList.contains('hidden')) {
                document.options.compendiumAs[CompendiumAsHtml ? 0 : 1].checked = true;
                OPTIONS_AREA.classList.add('fade-in');
                OPTIONS_AREA.classList.remove('hidden');
                OPTIONS_AREA.addEventListener('animationend',optionsFadeinDone);
            }

            function optionsFadeinDone() {
                OPTIONS_AREA.classList.remove('fade-in');
                OPTIONS_AREA.removeEventListener('animationend',optionsFadeinDone);
                window.addEventListener('click', optionsUserClicked);
            }

            function optionsUserClicked(e) {
                if (!OPTIONS_AREA.contains(e.target)) {
                    recordOptions();
                    window.removeEventListener('click', optionsUserClicked);
                    OPTIONS_AREA.classList.add('fade-out');
                    OPTIONS_AREA.addEventListener('animationend', optionsFadeoutDone);
                }
            }
            
            function optionsFadeoutDone() {
                OPTIONS_AREA.classList.add('hidden');
                OPTIONS_AREA.classList.remove('fade-out');
                OPTIONS_AREA.removeEventListener('animationend', optionsFadeoutDone);
            }
        }

        function recordOptions() {
            stateHistory = localStorage.getItem('stateHistory');
            var states = stateHistory.split(',');
            var last = Number(states.pop());
            if ((last < 0) || (last > 255)) {
                states.push(last.toString());
            }
            
            var optionsVal = (CompendiumIsPreferred ? 1 : 0) +
                             (CompendiumAsHtml ? 2 : 0);
            states.push(optionsVal.toString());
            localStorage.setItem('stateHistory', states.join(','));
        }

        function generateButton(buttonText, onclick = null, btnClass = 'modalBtn') {
            var ocevent = (onclick == null) ? '' : " onclick='" + onclick + "'";

            return "<button type='button' class='" + btnClass + "'" + ocevent + '>' + buttonText + '</button>';
        }

        function findStepNum(searchName) {
            var step = null;
            for (step = 0; step < sequence.steps.length; step++) {
                if (sequence.steps[step].name == searchName) {
                    break
                };
            };
            return step;
        }

        function modulo(dividend, divisor) { // because in javascript % is remainder not modulo
            return ((dividend % divisor) + divisor) % divisor
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
    </script>
</body>
</html>